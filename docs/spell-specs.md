# 魔術・祈祷スロットシステム仕様書

## 概要

本ドキュメントは、宿屋の「冒険の準備」メニューで実装する魔術・祈祷スロット管理システムの詳細仕様を定義します。

## 基本設計思想

### 魔術・祈祷の区別

- **魔術 (Spell)**: 知恵ベースの攻撃・補助魔法（魔術師、司教が使用）
- **祈祷 (Prayer)**: 信仰心ベースの回復・神聖魔法（僧侶、司教が使用）
- **共通システム**: 内部的には同じSpellSystemを使用、表示・習得方法で区別

### スロットシステム

- キャラクターレベルに応じたスロット数（最大9レベル分）
- 各レベルのスロットは独立した使用回数を持つ
- 地上帰還時に全スロットの使用回数が回復

## 詳細仕様

### 1. スロット構造

#### スロットレベルと数量

```yaml
spell_slots_per_level:
  1: 4  # レベル1スロット: 4個
  2: 3  # レベル2スロット: 3個
  3: 3  # レベル3スロット: 3個
  4: 2  # レベル4スロット: 2個
  5: 2  # レベル5スロット: 2個
  6: 1  # レベル6スロット: 1個
  7: 1  # レベル7スロット: 1個
  8: 1  # レベル8スロット: 1個
  9: 1  # レベル9スロット: 1個
```

#### 使用回数システム

- 各スロットは「スロットレベル」回の使用が可能
  - Lv1スロット: 1回使用可能
  - Lv2スロット: 2回使用可能
  - Lv9スロット: 9回使用可能

#### 魔法とスロットの関係

- 習得魔法レベル ≤ スロットレベル の場合のみ装備可能
- 例: Lv3魔法は Lv3以上のスロットにのみ装備可能

### 2. キャラクタークラス別制限

#### 魔術師 (Mage)

- **使用可能魔法**: 攻撃魔法、汎用魔法
- **禁止魔法**: 回復・蘇生系祈祷
- **スケーリング**: 知恵値で魔法威力決定

#### 僧侶 (Priest)  

- **使用可能魔法**: 回復・神聖魔法、汎用魔法
- **禁止魔法**: 攻撃系魔術
- **スケーリング**: 信仰心値で魔法効果決定

#### 司教 (Bishop)

- **使用可能魔法**: 全系統の魔法・祈祷
- **スケーリング**: 知恵・信仰心の高い方で効果決定

#### その他クラス

- **基本制限**: 魔法・祈祷使用不可
- **例外**: 特定の魔法アイテム使用で一時的習得可能

### 3. 魔法習得システム

#### 習得方法

1. **魔術書・祈祷書購入**: 魔術師ギルド・教会で購入
2. **魔法アイテム消費**: 宿屋のアイテム整理で使用
3. **レベルアップ報酬**: 特定レベル到達時の自動習得

#### 習得条件

- **レベル要件**: キャラクターレベル ≥ 魔法レベル
- **クラス要件**: 上記クラス別制限に従う
- **能力値要件**: 
  - 魔術: 知恵 ≥ 魔法レベル × 3
  - 祈祷: 信仰心 ≥ 魔法レベル × 3

### 4. UIデザイン

#### 宿屋-冒険の準備-魔術スロット設定

##### メイン画面構成

```
【魔術スロット設定】

キャラクター選択:
┌─────────────────────────────────┐
│ マルス (魔術師) Lv.5              │
│ スロット使用状況: 8/16           │
│ 習得魔法: 12個                   │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ エリナ (司教) Lv.4                │
│ スロット使用状況: 6/12           │
│ 習得魔法: 8個                    │
└─────────────────────────────────┘
```

##### 個別キャラクター管理画面

```
【マルス の魔術管理】

┌─ Lv1スロット (4個) ──────────────┐
│ [fireball  ] [ice_shard] [空     ] [空     ] │
│ 使用可能: 1/1  使用可能: 1/1   -      -    │
└─────────────────────────────────┘

┌─ Lv2スロット (3個) ──────────────┐
│ [lightning ] [空     ] [空     ]          │
│ 使用可能: 2/2   -       -              │
└─────────────────────────────────┘

習得済み魔法一覧:
┌─────────────────────────────────┐
│ □ fireball (Lv1) - 装備中            │
│ □ ice_shard (Lv1) - 装備中           │
│ □ magic_missile (Lv1)               │
│ □ lightning (Lv2) - 装備中           │
│ □ fireball_greater (Lv3)            │
└─────────────────────────────────┘

[スロットに装備] [装備解除] [戻る]
```

#### 操作フロー

1. **キャラクター選択**: 魔法使用可能キャラクターから選択
2. **スロット表示**: レベル別スロット状況を視覚的に表示
3. **魔法装備**: 習得済み魔法からスロットに装備
4. **装備解除**: 装備中魔法をスロットから解除
5. **確認・保存**: 変更内容を確認して保存

### 5. 祈祷スロット設定

祈祷スロット設定は魔術スロット設定とほぼ同様の仕様ですが、以下の点で異なります:

#### 相違点

- **対象キャラクター**: 僧侶・司教のみ
- **魔法フィルタリング**: 祈祷系魔法のみ表示
- **アイコン表示**: 🔮→📿に変更
- **UI表記**: 「魔術」→「祈祷」

### 6. 技術実装要件

#### データ構造

```python
@dataclass
class CharacterSpellSlots:
    character_id: str
    spell_slots: Dict[int, List[SpellSlot]]  # レベル別スロット
    learned_spells: List[str]                # 習得済み魔法ID
```

#### 主要メソッド

```python
def equip_spell_to_slot(character_id: str, spell_id: str, level: int, slot_index: int) -> bool
def unequip_spell_from_slot(character_id: str, level: int, slot_index: int) -> Optional[str]
def can_equip_spell(character: Character, spell: Spell, level: int) -> bool
def get_available_spells_for_character(character: Character) -> List[Spell]
def restore_all_spell_uses(character_id: str) -> None
```

#### UI要素

- `DirectScrolledList`: 習得魔法一覧表示
- `DirectButton`: スロット表示・装備ボタン
- `DirectFrame`: スロットレベル別グルーピング
- `DirectLabel`: 使用回数・ステータス表示

### 7. セーブ・ロードデータ

#### セーブデータ構造

```json
{
  "character_spell_data": {
    "character_id_1": {
      "learned_spells": ["fireball", "ice_shard", "lightning"],
      "spell_slots": {
        "1": [
          {"spell_id": "fireball", "current_uses": 1, "max_uses": 1},
          {"spell_id": "ice_shard", "current_uses": 0, "max_uses": 1},
          {"spell_id": null, "current_uses": 0, "max_uses": 1},
          {"spell_id": null, "current_uses": 0, "max_uses": 1}
        ],
        "2": [
          {"spell_id": "lightning", "current_uses": 2, "max_uses": 2},
          {"spell_id": null, "current_uses": 0, "max_uses": 2},
          {"spell_id": null, "current_uses": 0, "max_uses": 2}
        ]
      }
    }
  }
}
```

### 8. テスト要件

#### 単体テスト

- [ ] スロット装備・解除機能
- [ ] 魔法使用・回復機能  
- [ ] クラス・レベル制限チェック
- [ ] セーブ・ロード機能

#### 統合テスト

- [ ] UI操作フロー全体
- [ ] 複数キャラクター管理
- [ ] エラーハンドリング

#### シナリオテスト

- [ ] 新規キャラクターでの初期設定
- [ ] レベルアップ時のスロット増加
- [ ] 戦闘→地上帰還での回復

## 実装優先度

### Phase 1: 基盤実装

1. SpellSlot管理システム拡張
2. キャラクター別スロット初期化
3. 基本的な装備・解除機能

### Phase 2: UI実装

1. 宿屋メニュー統合
2. キャラクター選択UI
3. スロット管理UI

### Phase 3: 詳細機能

1. 魔法フィルタリング
2. 使用回数管理
3. エラーハンドリング

### Phase 4: 最適化・テスト

1. UI改善・最適化
2. 包括的テスト実装
3. パフォーマンス調整

## 関連ファイル

- `src/magic/spells.py`: 基盤魔法システム
- `src/overworld/facilities/inn.py`: 宿屋メニュー統合
- `src/character/character.py`: キャラクタースロット管理
- `config/spells.yaml`: 魔法定義
- `tests/test_spell_slots.py`: スロットシステムテスト
