# Bugs

発生しているバグ(Known bugs)と修正済みのバグをまとめます。
修正後、必ずテストを実施し、バグ履歴(Bugs history)へ移動してください

## Known bugs

### 優先度:高 (進行不可能)

現在、優先度:高の問題はありません。

### 優先度:中

### 優先度:低

* [ ] 各施設の主人との会話([宿屋の主人と話す]など)に表示されるタイルのウィンドウが小さい。もっと大きく表示するべき
* [ ] [冒険者ギルド]-[パーティ編成]-[現在の編成を確認]のテキスト表示がタイルから大きくはみ出ている。背面のタイルが小さい
* [ ] [冒険者ギルド]-[キャラクター一覧]のテキスト表示がタイルから大きくはみ出ている。リスト表示用のUI部品を使用するべき
    [商店]-[在庫確認]でも同様
* [ ] [冒険者ギルド]-[クラスチェンジ]が未実装
* [ ] [商店]-[アイテム購入]の各アイテムの先頭に文字化けした文字が付与されている
* [ ] ダンジョンへ遷移したあと、現在位置・レベル・コンパスの基本UIと操作ガイドUI以外灰色となり何も表示されない
* [ ] ダンジョンへ遷移したあと、WASDを入力すると"RROR - アクションコールバックエラー turn_right: 'DungeonRendererPygame' object has no attribute '_turn_right'" のログが発生する
* [ ] [教会]の[寄付をする]は削除する
* [ ] 各施設のメッセージUI上の[戻る]ボタンがメッセージの上に表示され、読みにくくなっている
* [ ] 設定画面-[設定]が未実装

## Bugs history


### 修正済み (2025-06-23)

* [x] 4階層より深いメニューからの戻る処理が正常に動作していない問題
  - 修正内容: 宿屋のキャラクター別アイテム管理メニューで新メニューシステムを使用するように変更
  - 問題: 4階層目メニューで旧システムの_show_submenuを使用しており、適切なスタック管理ができていなかった
  - 主要修正箇所:
    - inn.py: _show_character_item_management, _show_character_item_detailで新システム対応
    - 戻るボタンのコールバックでback_to_previous_menu()を使用するよう修正
  - テスト: test_menu_architecture_integration.pyで深い階層のメニューナビゲーションを確認
  - コミット: 701bb66

* [x] [魔術師ギルド]-[キャラクター個別分析]-[キャラクタ]を表示したあと、[戻る]が無い問題
  - 修正内容: 魔術師ギルドの全ダイアログに戻るボタンを追加
  - 問題: キャラクター個別分析など複数のダイアログでbuttonsパラメータが省略されていた
  - 修正箇所: _analyze_character, _show_character_spell_usage, _show_spellbook_details等6つのダイアログ
  - テスト: 各ダイアログから適切に戻れることを確認
  - コミット: 2809cf9

* [x] [魔術師ギルド]-[魔術書購入]でのダイアログコールバックエラー
  - 修正内容: 確認ダイアログのコールバック関数で引数の数を統一
  - 問題: DialogTemplateが確認結果のboolean値を渡すが、ラムダ関数が引数を受け取らない設定だった
  - 修正パターン: lambda confirmed=None: action() if confirmed else None
  - 影響範囲: 魔術師ギルド、冒険者ギルド、寺院の確認ダイアログ
  - テスト: 魔術書購入の流れが正常に動作することを確認
  - コミット: 6346f94

* [x] [宿屋]-[酒場の噂話]のあと[OK]を押すとメニューが空になる問題
  - 修正内容: BaseFacilityとInnクラスでダイアログ終了後のメニュー復元処理を改善
  - 問題: ui_managerがNoneの場合やfacility_managerの処理でメインメニューが復元されなかった
  - 主要修正箇所:
    - base_facility.py: _close_dialog, _exit_facilityでの安全性向上
    - inn.py: _show_tavern_rumors, _talk_to_innkeeper, _show_travel_infoでの明示的なメニュー復元
  - テスト: test_inn_tavern_rumors_fix.pyで噂話ダイアログの適切な処理を確認
  - コミット: 7c10fb0

* [x] [冒険者ギルド]-[キャラクタ作成] で名前入力後、名前入力のエディットボックスが残り続ける
  - 修正内容: character_creation.pyで名前入力ダイアログの完全削除処理を実装
  - 問題: UIManager.hide_dialog()はダイアログを非表示にするだけで、dialogsディクショナリからは削除されないため、render()で継続して描画されていた
  - 解決: _on_name_confirmed()と_on_name_cancelled()で`del ui_manager.dialogs[dialog_id]`による完全削除を追加、安全性チェックも実装
  - テスト: test_character_creation_name_input_fix.pyで5項目のテストが全て通過、TDD手法による修正確認
* [x] 設定画面-[ゲームを保存]で保存先スロット選択画面が表示されない
* [x] 設定画面-[ゲームをロード]でロード元スロット選択画面が表示されない
* [x] [宿屋]-[冒険の準備]-[アイテム整理]-[宿屋倉庫の確認]が実装されていない
* [x] [ダンジョン入口]を選択すると、いきなりダンジョンへ遷移する。ダンジョン選択画面を表示するべき
    * ダンジョン選択画面では、ダンジョンの一覧が表示される。一覧には、ダンジョン名、難易度、属性、踏破済みかどうかの情報が表示される
    * [ダンジョンへ入る]で選択したダンジョンへ遷移する
    * [ダンジョン新規生成]で、自動生成したハッシュ値から新規ダンジョンを生成し、一覧に登録する
    * [ダンジョン破棄]で、一覧からダンジョンを破棄する
* [x] [冒険者ギルド]の画面を表示中にESCを押すと、背面の地上メニューのみが設定画面メニューに切り替わる。設定画面へ切り替わるべき

