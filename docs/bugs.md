# Bugs

発生しているバグ(Known bugs)と修正済みのバグをまとめます。
修正後、必ずテストを実施し、バグ履歴(Bugs history)へ移動してください

## Known bugs

### 優先度:高 (進行不可能)

現在、優先度:高の問題はありません。

### 優先度:中

* [x] [冒険者ギルド]-[キャラクタ作成] で名前入力後、名前入力のエディットボックスが残り続ける
  - 修正内容: character_creation.pyで名前入力ダイアログの完全削除処理を実装
  - 問題: UIManager.hide_dialog()はダイアログを非表示にするだけで、dialogsディクショナリからは削除されないため、render()で継続して描画されていた
  - 解決: _on_name_confirmed()と_on_name_cancelled()で`del ui_manager.dialogs[dialog_id]`による完全削除を追加、安全性チェックも実装
  - テスト: test_character_creation_name_input_fix.pyで5項目のテストが全て通過、TDD手法による修正確認
* [ ] [ダンジョン入口]を選択すると、いきなりダンジョンへ遷移する。ダンジョン選択画面を表示するべき
    * ダンジョン選択画面では、ダンジョンの一覧が表示される。一覧には、ダンジョン名、難易度、属性、踏破済みかどうかの情報が表示される
    * [ダンジョンへ入る]で選択したダンジョンへ遷移する
    * [ダンジョン新規生成]で、自動生成したハッシュ値から新規ダンジョンを生成し、一覧に登録する
    * [ダンジョン破棄]で、一覧からダンジョンを破棄する
* [ ] 設定画面-[ゲームを保存]で保存先スロット選択画面が表示されない
* [ ] 設定画面-[ゲームをロード]でロード元スロット選択画面が表示されない
* [ ] [宿屋]-[冒険の準備]-[アイテム整理]-[宿屋倉庫の確認]が実装されていない

### 優先度:低

* [ ] 各施設の主人との会話([宿屋の主人と話す]など)に表示されるタイルのウィンドウが小さい。もっと大きく表示するべき
* [ ] [冒険者ギルド]の画面を表示中にESCを押すと、背面の地上メニューのみが設定画面メニューに切り替わる。設定画面へ切り替わるべき
* [ ] [冒険者ギルド]-[パーティ編成]-[現在の編成を確認]のテキスト表示がタイルから大きくはみ出ている。背面のタイルが小さい
* [ ] [冒険者ギルド]-[キャラクター一覧]のテキスト表示がタイルから大きくはみ出ている。リスト表示用のUI部品を使用するべき
    [商店]-[在庫確認]でも同様
* [ ] [冒険者ギルド]-[クラスチェンジ]が未実装
* [ ] [商店]-[アイテム購入]の各アイテムの先頭に文字化けした文字が付与されている
* [ ] ダンジョンへ遷移したあと、現在位置・レベル・コンパスの基本UIと操作ガイドUI以外灰色となり何も表示されない
* [ ] ダンジョンへ遷移したあと、WASDを入力すると"RROR - アクションコールバックエラー turn_right: 'DungeonRendererPygame' object has no attribute '_turn_right'" のログが発生する
* [ ] [教会]の[寄付をする]は削除する
* [ ] 各施設のメッセージUI上の[戻る]ボタンがメッセージの上に表示され、読みにくくなっている
* [ ] 設定画面-[設定]が未実装

## Bugs history

### 修正済み (2025-06-22)

* [x] [冒険者ギルド]から地上メニューに戻ることができない。[商店]、[教会]なども同様
  - 修正内容: overworld_manager_pygame.pyでFacilityManagerを使用するように変更
  - テスト: 冒険者ギルドに入って「出る」ボタンで地上メニューに正常に戻ることを確認
  - コミット: 9f3fb58

* [x] [冒険者ギルド]-[パーティ編成]-[現在の編成を確認]から元の[パーティ編成]メニューに戻らない
* [x] [冒険者ギルド]-[キャラクター作成]でキャラクター作成後、[キャラクター一覧]のメニューが表示され、[冒険者ギルド]のメニューに戻れない
    [商店]-[在庫確認]でも同様
* [x] [冒険者ギルド]-[クラスチェンジ]から元の[冒険者ギルド]に戻れない
* [x] [商店]-[アイテム購入]から[商店]メニューに戻れない
* [x] [教会]-[蘇生サービス]から元の教会メニューに戻れない
* [x] [魔術師ギルド]-[アイテム解析]から元の魔術師ギルドメニューに戻れない
* [x] [冒険者ギルド]-[パーティ編成]-[キャラクターを削除]でパーティからキャラクターを削除できない
* [x] 地上画面で1回、[冒険者ギルド]を押しても何も反応せず、もう一回押したら[冒険者ギルド]画面へ遷移する。[商店]でも同様
* [x] [商店]-[アイテム購入]でアイテムを購入するとクラッシュする。[祈祷書購入]、[魔術書購入]でも同様の現象が発生
  - 修正内容: shop.py、temple.py、inn.py、magic_guild.pyでUIDialog直接作成を_show_dialog()に変更
  - 問題: UIDialog(buttons=...)の引数がPygame版UIDialogでサポートされていなかった
  - テスト: 商店でのアイテム購入、教会での祝福サービス、宿屋での装備変更、魔術師ギルドでの鑑定サービスが正常動作することを確認

* [x] [教会]-[祝福サービス]を選択するとクラッシュする
  - 修正内容: 上記と同じUIDialog直接作成問題を修正
  - テスト: 教会の祝福サービスが正常に動作することを確認

* [x] [宿屋]での装備変更・魔術書使用時のクラッシュ
  - 修正内容: inn.pyでUIDialog直接作成を_show_dialog()に変更
  - テスト: 宿屋での装備変更と魔術書・祈祷書使用が正常動作することを確認

* [x] [魔術師ギルド]でのアイテム鑑定時のクラッシュ
  - 修正内容: magic_guild.pyでUIDialog直接作成を_show_dialog()に変更
  - テスト: 魔術師ギルドでのアイテム鑑定が正常動作することを確認

* [x] [冒険者ギルド]-[クラスチェンジ]-[戻る]-[終了]で地上メニューに戻ると、地上メニューに対して操作ができない
  - 同様の現象: [商店]-[商店の主人と話す]-[戻る]-[終了]などの、施設のサブメニューを経由すると発生
  - 修正内容: overworld_manager_pygame.pyでメインメニューを必ずmodal=Trueで表示するように修正
  - 問題: 施設退出後に地上メニューがモーダルスタックに登録されておらず、イベント処理が正常に行われなかった
  - テスト: 冒険者ギルドでクラスチェンジ→戻る→終了、商店で主人と話す→戻る→終了の流れで地上メニューが正常に操作できることを確認

* [x] [冒険者ギルド]-[パーティ編成]-[位置を変更]で前と同じ位置を選択すると、「エラー 位置の変更に失敗しました」と表示されたあと、[OK]、[戻る]どちらのボタンも操作を受け付けなくなる
  - 修正内容: 同じ位置選択を防止、メニュー階層管理の改善
  - 問題: 現在位置も選択肢に含まれていたため、同じ位置選択でエラーが発生していた
  - テスト: 位置変更で現在位置が選択肢に表示されないことを確認

* [x] [冒険者ギルド]-[パーティ編成]-[位置を変更]で位置を変更後、位置変更用のメニューが表示されたままになるが[戻る]キーは効かない
  - 修正内容: 位置変更後のメニュークリーンアップを改善、適切なダイアログコールバックを実装
  - 問題: 位置変更後のメニュー階層管理が不適切だった
  - テスト: 位置変更完了後に適切にパーティ編成メニューに戻ることを確認

* [x] [冒険者ギルド]-[パーティ編成]-[キャラクター削除]を行ってもパーティ削除メニューが表示されままになる
  - 修正内容: キャラクター削除後のメニュークリーンアップを改善、適切なダイアログコールバックを実装
  - 問題: 削除後のメニュー階層管理が不適切だった
  - テスト: キャラクター削除完了後に適切にパーティ編成メニューに戻ることを確認

* [x] [宿屋]メニューが表示されない
  - 修正内容: inn.pyで_show_item_storageメソッドが存在しないエラーを修正
  - 問題: メニュー項目で参照されているメソッド名が実装されているメソッド名と不一致
  - テスト: 宿屋メニューが正常に表示され、各メニュー項目が動作することを確認
  - コミット: 86b7c74

* [x] [商店]でアイテムを購入後、[アイテム売却]を開いても、「売却可能なアイテムがありません」と表示される
  - 修正内容: 売却システムを新しいアイテム管理システム（宿屋倉庫 + キャラクター個人インベントリ）に対応
  - 問題: 購入したアイテムは宿屋倉庫に搬入されるが、売却システムが古いパーティインベントリのみを参照していた
  - テスト: アイテム購入後に宿屋倉庫およびキャラクター所持品から売却できることを確認
  - コミット: 86b7c74

* [x] 各種施設のサブメニューから戻れなくなる
  - [商店]-[アイテム売却]から[商店]メニューへ戻ることができない
  - [教会]-[蘇生サービス]を選択したあと、元の教会メニューへ戻ることができない(死者なしの場合)
  - [教会]-[神父と話す]を選択したあと、元の教会メニューへ戻ることができない
  - [魔術師ギルド]-[大魔術師と話す]から元のメニューに戻れない
  - 修正内容: 各ダイアログに適切な戻るボタンを追加
  - 問題: buttonsパラメータが指定されていないダイアログが存在し、戻る手段がなかった
  - テスト: 各施設のダイアログから適切に戻れることを確認

* [x] 設定画面-[パーティ状況]を選択するとクラッシュする
  - 修正内容: overworld_manager_pygame.pyでcharacter.levelをcharacter.experience.levelに修正、UIダイアログで詳細情報を表示するように実装
  - 問題: Characterクラスのlevel属性が実際にはexperience.levelとして格納されていたが、間違った属性名でアクセスしていた
  - テスト: 設定画面のパーティ状況が正常に表示され、パーティの詳細情報（名前、メンバー、ゴールド、各キャラのレベル/HP/MP/状態）がダイアログで確認できることを確認

* [x] [冒険者ギルド]-[パーティ編成]-[現在の編成を確認]から戻れない問題
  - 修正内容: guild.pyで現在の編成確認ダイアログに戻るボタンを追加、専用のクローズハンドラーを実装、メインメニュー表示時にmodal=Trueを追加
  - 問題: _show_current_formationメソッドでダイアログにボタンが指定されておらず、_close_dialogがメインメニューに戻るため、パーティ編成メニューから冒険者ギルドメインメニューに正しく戻れなかった
  - テスト: [冒険者ギルド]→[パーティ編成]→[現在の編成を確認]→[戻る]→[戻る]→[出る]の流れで地上メニューまで正常に戻れることを確認

* [x] 地上マップでの施設のメニュー開始-終了処理の統一とESCキー処理の修正 (2025-06-23)
  - 修正内容: MenuStackManagerとの連携によるESCキー処理の統一、ダイアログ処理の改善、宿屋スペルスロット設定でのOKボタン修正
  - 問題: ESCキー処理の不整合（冒険者ギルド画面が残存）、スペルスロット設定の"装備しました"ダイアログでOKボタンが反応しない、メニュー階層管理の不統一
  - 主要修正箇所:
    - overworld_manager_pygame.py: MenuStackManagerとの連携、ESCキー処理の委譲
    - base_facility.py: ui_managerのNoneチェック追加、ダイアログ処理の安全性向上
    - inn.py: _equip_spell_to_slotでの成功/エラーメッセージダイアログにカスタムコールバック追加
  - テスト: test_menu_navigation_bug_fixes.pyで10項目のテストが全て通過、TDD手法による修正確認
  - コミット: (次のコミットで記録予定)

* [x] 地上マップでの施設のメニュー開始-終了がうまく行ったりいかなかったりする (修正済み)
    例:
    - NG: [冒険者ギルド]-ESCキー→冒険者ギルド画面が全面に出たまま裏の地上メニューだけが設定画面に切り替わる 
      → 修正: ESCキー処理を施設の状態を考慮して適切に委譲するように変更
    - NG: [宿屋]-[冒険の準備]-[魔術スロット設定]-[魔法をスロットに装備]-[スロット1] -> "装備しました"のメッセージが出ても[OK]ボタンを押しても何も起きない
      → 修正: 新旧メニューシステム両対応のダイアログコールバック処理を実装

* [x] [宿屋]-[冒険の準備]-[魔術スロット設定]で魔法装備後の[戻る]キーが効かない問題 (修正済み)
    - 修正内容: 魔術スロット詳細メニューの戻るボタンを_show_adventure_preparationに変更
    - 問題: 戻るボタンが_show_new_spell_user_selectionを呼んでいたため、適切にメニュー階層を戻れなかった
    - テスト: test_spell_slot_equipment_flow.pyで戻るボタンの動作を確認

### 修正済み (2025-06-23)

* [x] 4階層より深いメニューからの戻る処理が正常に動作していない問題
  - 修正内容: 宿屋のキャラクター別アイテム管理メニューで新メニューシステムを使用するように変更
  - 問題: 4階層目メニューで旧システムの_show_submenuを使用しており、適切なスタック管理ができていなかった
  - 主要修正箇所:
    - inn.py: _show_character_item_management, _show_character_item_detailで新システム対応
    - 戻るボタンのコールバックでback_to_previous_menu()を使用するよう修正
  - テスト: test_menu_architecture_integration.pyで深い階層のメニューナビゲーションを確認
  - コミット: 701bb66

* [x] [魔術師ギルド]-[キャラクター個別分析]-[キャラクタ]を表示したあと、[戻る]が無い問題
  - 修正内容: 魔術師ギルドの全ダイアログに戻るボタンを追加
  - 問題: キャラクター個別分析など複数のダイアログでbuttonsパラメータが省略されていた
  - 修正箇所: _analyze_character, _show_character_spell_usage, _show_spellbook_details等6つのダイアログ
  - テスト: 各ダイアログから適切に戻れることを確認
  - コミット: 2809cf9

* [x] [魔術師ギルド]-[魔術書購入]でのダイアログコールバックエラー
  - 修正内容: 確認ダイアログのコールバック関数で引数の数を統一
  - 問題: DialogTemplateが確認結果のboolean値を渡すが、ラムダ関数が引数を受け取らない設定だった
  - 修正パターン: lambda confirmed=None: action() if confirmed else None
  - 影響範囲: 魔術師ギルド、冒険者ギルド、寺院の確認ダイアログ
  - テスト: 魔術書購入の流れが正常に動作することを確認
  - コミット: 6346f94

* [x] [宿屋]-[酒場の噂話]のあと[OK]を押すとメニューが空になる問題
  - 修正内容: BaseFacilityとInnクラスでダイアログ終了後のメニュー復元処理を改善
  - 問題: ui_managerがNoneの場合やfacility_managerの処理でメインメニューが復元されなかった
  - 主要修正箇所:
    - base_facility.py: _close_dialog, _exit_facilityでの安全性向上
    - inn.py: _show_tavern_rumors, _talk_to_innkeeper, _show_travel_infoでの明示的なメニュー復元
  - テスト: test_inn_tavern_rumors_fix.pyで噂話ダイアログの適切な処理を確認
  - コミット: 7c10fb0

