# 現象

サブメニューから戻れなくなっている

# 再現方法
 [魔術師ギルド]-[魔法分析]-[キャラクター個別分析]-[戻る]を押しても[魔法分析]に戻れない

# 調査結果と修正

## 問題1: 魔術師ギルドのキャラクター分析ダイアログ ✅ 修正済み

### 根本原因
`MagicGuild._analyze_character()`でキャラクター分析ダイアログの戻るボタンが`self._close_dialog`に設定されていた。
`_close_dialog()`は施設のメインメニューに戻るため、期待される「キャラクター個別分析」メニューではなく「魔術師ギルドメインメニュー」に戻ってしまう。

### 修正内容
- キャラクター分析ダイアログの戻るボタンを`self._close_dialog`から`self._show_character_analysis_menu`に変更
- これにより、ダイアログから戻る時に適切な親メニュー（キャラクター個別分析）に戻るようになった

### 修正対象ファイル
- `src/overworld/facilities/magic_guild.py`: LINE 690の戻るボタンコマンド修正

## 問題2: 他の施設でも同様の問題が存在 ❌ 未修正

### 調査結果
以下の施設でも同様の問題があることを確認：

#### Temple（教会）
- 蘇生、祝福、神父会話ダイアログで`self._close_dialog`を直接使用
- 複数階層メニューから呼ばれた場合に不適切なメニューに戻る可能性

#### Shop（商店）  
- アイテム詳細、売却確認、商店主会話ダイアログで同様の問題
- 一部では適切なコールバック実装済み（参考にできる）

#### Inn（宿屋）
- 主人会話、情報、倉庫関連ダイアログで同様の問題
- 新旧システム併用のため修正方法が複雑

#### Guild（冒険者ギルド）
- キャラクター一覧、クラスチェンジダイアログで同様の問題
- 比較的適切な階層管理がされているが一部に問題箇所

 # TODO
1. ✅ 調査後、上記エラーを検知するテストを作成する
2. ✅ 修正する（魔術師ギルドは完了、他施設は別途対応が必要）
3. ✅ テストが成功することを確認する
4. ⏳ commitする
5. 🆕 他の施設の同様問題を修正する（別タスクとして実施）

## 修正内容まとめ
**魔術師ギルド**: キャラクター分析ダイアログの戻るボタンを適切なメニューに修正完了
**他の施設**: 同様の問題があることを確認、別途修正が必要
