# 0093_update_facilities.md - æ–½è¨­UIçµ±åˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è¨ˆç”»

## æ¦‚è¦

æ–½è¨­UIæ©Ÿèƒ½ã®çµ±åˆçš„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿæ–½ã€‚éå»ä½•åº¦ã‚‚ç™ºç”Ÿã—ã¦ã„ãŸãƒ‘ãƒãƒ«ç ´æ£„å‡¦ç†ã®ä¸å…·åˆã‚’æ ¹æœ¬çš„ã«è§£æ±ºã™ã‚‹ãŸã‚ã€çµ±ä¸€ã•ã‚ŒãŸUIç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’å°å…¥ã™ã‚‹ã€‚

## èƒŒæ™¯

### ç™ºç”Ÿã—ã¦ã„ãŸå•é¡Œ
- ç”»é¢åˆ‡æ›¿æ™‚ã®ãƒ‘ãƒãƒ«ç ´æ£„å‡¦ç†ã§é »ç™ºã™ã‚‹ä¸å…·åˆ
- 3ã¤ã®ç•°ãªã‚‹ç ´æ£„ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ··åœ¨ï¼ˆåŸºæœ¬ãƒ»å¼·åŒ–ãƒ»æœ€é«˜åº¦ï¼‰
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®å¯èƒ½æ€§
- UIéšå±¤ã®è¤‡é›‘æ€§ã«ã‚ˆã‚‹ãƒ‡ãƒãƒƒã‚°å›°é›£

### æ ¹æœ¬åŸå› 
- çµ±ä¸€ã•ã‚ŒãŸUIç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ¬ å¦‚
- ç ´æ£„å‡¦ç†ã®ä¸çµ±ä¸€æ€§
- ä¾‹å¤–å®‰å…¨æ€§ã®ä¸è¶³
- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®ä¸è¶³

## å®Ÿè£…æ¸ˆã¿é …ç›® âœ…

### 1. UIElementManager ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/facilities/ui/ui_element_manager.py`

**æ©Ÿèƒ½**:
- çµ±ä¸€ã•ã‚ŒãŸUIè¦ç´ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
- å‹å®‰å…¨ãªè¦ç´ ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰
- ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ã¨éšå±¤çš„ç ´æ£„æ©Ÿèƒ½
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•ç®¡ç†
- ç ´æ£„æ¤œè¨¼æ©Ÿèƒ½

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
- `create_label()`, `create_button()`, `create_selection_list()` ãªã©
- `destroy_all()` - ä¾‹å¤–å®‰å…¨ãªå®Œå…¨ç ´æ£„
- `add_to_group()`, `destroy_group()` - ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†
- `get_debug_info()` - ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—

### 2. çµ±ä¸€ç ´æ£„å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/facilities/ui/service_panel.py`

**æ”¹å–„ç‚¹**:
- `DestructionMixin`ã«ã‚ˆã‚‹æ¤œè¨¼ä»˜ãç ´æ£„å‡¦ç†
- `ServicePanel`åŸºåº•ã‚¯ãƒ©ã‚¹ã®å¼·åŒ–
- UIElementManagerã¨ã®çµ±åˆ
- å¾Œæ–¹äº’æ›æ€§ã‚’ä¿ã¡ãªãŒã‚‰ã®æ®µéšçš„ç§»è¡Œ

**æ–°ã—ã„ç ´æ£„ãƒ•ãƒ­ãƒ¼**:
```python
def destroy(self) -> None:
    # 1. UIElementManagerã«ã‚ˆã‚‹çµ±ä¸€ç ´æ£„
    self.ui_element_manager.destroy_all()
    
    # 2. å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®legacyç ´æ£„
    for element in self.ui_elements:
        element.kill()
    
    # 3. ã‚³ãƒ³ãƒ†ãƒŠã¨ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã®ã‚¯ãƒªã‚¢
    self.container.kill()
    self.container = None
```

### 3. ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã®å¤§å¹…å¼·åŒ–
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/core/dbg_api.py`

**æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `/debug/facility-ui` - æ–½è¨­UIå°‚ç”¨ã®è©³ç´°åˆ†æ
- `/debug/ui-snapshot` - UIçŠ¶æ…‹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆ

**æä¾›ã•ã‚Œã‚‹è¨ºæ–­æƒ…å ±**:
- æ–½è¨­ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çŠ¶æ…‹
- ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹
- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹
- ç ´æ£„å‡¦ç†ã®å®Œå…¨æ€§è¨ºæ–­
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œå‡º

### 4. BuyPanelã®å®Œå…¨ç§»è¡Œ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/facilities/ui/shop/buy_panel.py`

**ç§»è¡Œå†…å®¹**:
- æ–°ã—ã„UIElementManagerã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å®Œå…¨ç§»è¡Œ
- `_create_label()`, `_create_button()` ãªã©ã®æ–°ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
- å¾“æ¥ã®`ui_elements`ãƒªã‚¹ãƒˆã¨æ–°ã‚·ã‚¹ãƒ†ãƒ ã®ä½µç”¨
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã«ã‚ˆã‚‹å®‰å…¨æ€§ç¢ºä¿

## ä»Šå¾Œã®å®Ÿè£…è¨ˆç”» ğŸ“‹

### Phase 1: ä¸»è¦ãƒ‘ãƒãƒ«ã®ç§»è¡Œï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
**æœŸé–“**: 2-3é€±é–“

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/facilities/ui/shop/sell_panel.py`
- `src/facilities/ui/shop/identify_panel.py`
- `src/facilities/ui/inn/storage_panel.py`
- `src/facilities/ui/inn/item_management_panel.py`

**ä½œæ¥­å†…å®¹**:
1. å„ãƒ‘ãƒãƒ«ã§UIElementManagerã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ç§»è¡Œ
2. æ–°ã—ã„`_create_*`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
3. ç ´æ£„å‡¦ç†ã®çµ±ä¸€åŒ–
4. ãƒ†ã‚¹ãƒˆã®æ›´æ–°

### Phase 2: è¤‡é›‘ãªãƒ‘ãƒãƒ«ã®ç§»è¡Œï¼ˆä¸­å„ªå…ˆåº¦ï¼‰
**æœŸé–“**: 3-4é€±é–“

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/facilities/ui/guild/character_list_panel.py`
- `src/facilities/ui/guild/party_formation_panel.py`
- `src/facilities/ui/guild/character_creation_wizard.py`
- `src/facilities/ui/inn/adventure_prep_panel.py`

**ä½œæ¥­å†…å®¹**:
1. è¤‡é›‘ãªUIæ§‹é€ ã®åˆ†æ
2. å…±é€šUIãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŠ½å‡º
3. æ®µéšçš„ãªç§»è¡Œ
4. çµ±åˆãƒ†ã‚¹ãƒˆã®å¼·åŒ–

### Phase 3: Templeç³»ã®æ¨™æº–åŒ–ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰
**æœŸé–“**: 2é€±é–“

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/facilities/ui/temple/blessing_panel.py`
- `src/facilities/ui/temple/resurrect_panel.py`
- `src/facilities/ui/temple/prayer_shop_panel.py`

**ä½œæ¥­å†…å®¹**:
1. ServicePanelç¶™æ‰¿ã¸ã®ç§»è¡Œ
2. çµ±ä¸€ã•ã‚ŒãŸUIä½œæˆãƒ»ç ´æ£„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨
3. è¨­è¨ˆã®ä¸€è²«æ€§ç¢ºä¿

### Phase 4: å…±é€šUIãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŠ½å‡ºï¼ˆä½å„ªå…ˆåº¦ï¼‰
**æœŸé–“**: 4-5é€±é–“

**æ–°ã—ã„ã‚¯ãƒ©ã‚¹**:
- `ListDetailPanel` - å·¦å´ãƒªã‚¹ãƒˆï¼‹å³å´è©³ç´°ã®æ¨™æº–ãƒ‘ã‚¿ãƒ¼ãƒ³
- `DualListPanel` - åŒæ–¹å‘ãƒªã‚¹ãƒˆç®¡ç†ã®æ¨™æº–ãƒ‘ã‚¿ãƒ¼ãƒ³
- `FormPanel` - ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼ã®å…¥åŠ›ãƒ‘ã‚¿ãƒ¼ãƒ³

**ä½œæ¥­å†…å®¹**:
1. å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŠ½è±¡åŒ–
2. åŸºåº•ã‚¯ãƒ©ã‚¹ã®ä½œæˆ
3. æ—¢å­˜ãƒ‘ãƒãƒ«ã®ç§»è¡Œ
4. ã‚³ãƒ¼ãƒ‰é‡è¤‡ã®å‰Šæ¸›

## æŠ€è¡“çš„è©³ç´°

### UIElementManager ã®è¨­è¨ˆæ€æƒ³
```python
# çµ±ä¸€ã•ã‚ŒãŸUIè¦ç´ ç®¡ç†
manager = UIElementManager(ui_manager, container)

# å‹å®‰å…¨ãªè¦ç´ ä½œæˆ
button = manager.create_button("save_btn", "ä¿å­˜", rect)
label = manager.create_label("title", "ã‚¿ã‚¤ãƒˆãƒ«", rect)

# ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†
with manager.element_group("form_controls"):
    # ã“ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã§ä½œæˆã•ã‚ŒãŸè¦ç´ ã¯è‡ªå‹•çš„ã«ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
    input_field = manager.create_text_entry("input", rect)
    submit_btn = manager.create_button("submit", "é€ä¿¡", rect)

# å®‰å…¨ãªç ´æ£„
manager.destroy_group("form_controls")  # ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§ã®ç ´æ£„
manager.destroy_all()  # å®Œå…¨ç ´æ£„
```

### ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®æ´»ç”¨
```python
# æ–½è¨­UIå°‚ç”¨ã®è¨ºæ–­
debug_info = requests.get("http://localhost:8765/debug/facility-ui").json()

# ãƒ‘ãƒãƒ«ç ´æ£„çŠ¶æ³ã®ç¢ºèª
destruction_status = debug_info["destruction_analysis"]
if destruction_status["destruction_completeness"] == "poor":
    print("ç ´æ£„å‡¦ç†ã«å•é¡ŒãŒã‚ã‚Šã¾ã™")

# ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®æ¤œå‡º
memory_issues = debug_info["ui_memory_issues"]
for issue in memory_issues:
    if issue["type"] == "excessive_elements":
        print(f"è¦ç´ æ•°ãŒç•°å¸¸: {issue['element_type']} x{issue['count']}")
```

### æ®µéšçš„ç§»è¡Œã®æˆ¦ç•¥
1. **æ–°ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥**: UIElementManagerã‚’å„ãƒ‘ãƒãƒ«ã«çµ±åˆ
2. **å¾Œæ–¹äº’æ›æ€§ã®ç¢ºä¿**: æ—¢å­˜ã®`ui_elements`ãƒªã‚¹ãƒˆã‚‚ä¸¦è¡Œã—ã¦ç®¡ç†
3. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½**: æ–°ã‚·ã‚¹ãƒ†ãƒ ãŒå¤±æ•—ã—ãŸå ´åˆã®å¾“æ¥æ–¹å¼ã¸ã®åˆ‡ã‚Šæ›¿ãˆ
4. **æ®µéšçš„ãƒ†ã‚¹ãƒˆ**: å„ãƒ‘ãƒãƒ«ã®ç§»è¡Œå®Œäº†æ™‚ã«å€‹åˆ¥ãƒ†ã‚¹ãƒˆ
5. **çµ±åˆãƒ†ã‚¹ãƒˆ**: å…¨ä½“ã®æ•´åˆæ€§ç¢ºèª

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### çŸ­æœŸçš„åŠ¹æœï¼ˆ1-2ãƒ¶æœˆï¼‰
- ãƒ‘ãƒãƒ«ç ´æ£„å‡¦ç†ã®ä¸å…·åˆæ ¹çµ¶
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®å¤§å¹…å‰Šæ¸›
- ãƒ‡ãƒãƒƒã‚°åŠ¹ç‡ã®å‘ä¸Š
- é–‹ç™ºè€…ã®ç”Ÿç”£æ€§å‘ä¸Š

### ä¸­æœŸçš„åŠ¹æœï¼ˆ3-6ãƒ¶æœˆï¼‰
- ã‚³ãƒ¼ãƒ‰é‡è¤‡ã®30-40%å‰Šæ¸›
- æ–°ã—ã„ãƒ‘ãƒãƒ«ä½œæˆæ™‚é–“ã®50%çŸ­ç¸®
- ãƒã‚°ç™ºç”Ÿç‡ã®å¤§å¹…æ¸›å°‘
- ä¿å®ˆæ€§ã®å‘ä¸Š

### é•·æœŸçš„åŠ¹æœï¼ˆ6ãƒ¶æœˆä»¥ä¸Šï¼‰
- æ–½è¨­UIå…¨ä½“ã®è¨­è¨ˆä¸€è²«æ€§
- æ–°æ©Ÿèƒ½è¿½åŠ ã®å®¹æ˜“ã•
- ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å®‰å®šæ€§å‘ä¸Š
- æŠ€è¡“çš„è² å‚µã®å¤§å¹…å‰Šæ¸›

## ãƒªã‚¹ã‚¯ç®¡ç†

### æŠ€è¡“çš„ãƒªã‚¹ã‚¯
- **æ—¢å­˜æ©Ÿèƒ½ã®ç ´æ**: æ®µéšçš„ç§»è¡Œã¨ååˆ†ãªãƒ†ã‚¹ãƒˆã§å¯¾å‡¦
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åŠ£åŒ–**: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹ç›£è¦–
- **è¤‡é›‘æ€§ã®å¢—åŠ **: æ˜ç¢ºãªè¨­è¨ˆæ–‡æ›¸ã¨æ•™è‚²ã§å¯¾å‡¦

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ã‚¯
- **ä½œæ¥­é‡ã®å¢—åŠ **: å„ªå…ˆåº¦ã‚’æ˜ç¢ºã«ã—ã¦æ®µéšçš„ã«å®Ÿæ–½
- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é…å»¶**: é‡è¦åº¦ã«å¿œã˜ãŸèª¿æ•´
- **å“è³ªã®ä½ä¸‹**: ç¶™ç¶šçš„ãªãƒ†ã‚¹ãƒˆã¨æ¤œè¨¼

## æˆåŠŸæŒ‡æ¨™

### å®šé‡çš„æŒ‡æ¨™
- ãƒ‘ãƒãƒ«ç ´æ£„å‡¦ç†ã®ä¾‹å¤–ç™ºç”Ÿæ•°: 0ä»¶/æœˆ
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œå‡ºä»¶æ•°: 80%å‰Šæ¸›
- ã‚³ãƒ¼ãƒ‰é‡è¤‡ç‡: 30-40%å‰Šæ¸›
- æ–°ãƒ‘ãƒãƒ«ä½œæˆæ™‚é–“: 50%çŸ­ç¸®

### å®šæ€§çš„æŒ‡æ¨™
- é–‹ç™ºè€…ã®æº€è¶³åº¦å‘ä¸Š
- ãƒã‚°å ±å‘Šã®è³ªçš„æ”¹å–„
- ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åŠ¹ç‡åŒ–
- æ–°è¦é–‹ç™ºè€…ã®å­¦ç¿’ã‚³ã‚¹ãƒˆå‰Šæ¸›

## é–¢é€£æ–‡æ›¸

- [ãƒ•ã‚©ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚¬ã‚¤ãƒ‰](../font_system_guide.md)
- [ã‚²ãƒ¼ãƒ ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰](../how_to_debug_game.md)
- [pygame_guiçµ±åˆã‚¬ã‚¤ãƒ‰](../pygame_gui_font_integration.md)

## å¤‰æ›´å±¥æ­´

- 2025-07-19: åˆç‰ˆä½œæˆ
- 2025-07-19: Phase 1å®Œäº†ï¼ˆUIElementManagerå°å…¥ã€ServicePanelå¼·åŒ–ã€BuyPanelç§»è¡Œï¼‰

---

**æ‹…å½“è€…**: Claude Code  
**ä½œæˆæ—¥**: 2025-07-19  
**æœ€çµ‚æ›´æ–°**: 2025-07-19  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 1å®Œäº†ã€ç¶™ç¶šä¸­