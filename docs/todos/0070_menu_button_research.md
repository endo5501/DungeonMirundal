# メニューボタン調査結果

現在、各メニュー画面の操作を行うと、メニューが非表示になる、クラッシュするなどの問題が発生している。

@docs/how_to_debug_game.md を使用して各施設のメニューのボタンを網羅的に調査した結果：

## 最終調査結果サマリー（2025年7月4日完了）

### 問題の特定（再調査による確認）
1. **すべての施設が同じ問題** - 冒険者ギルド、宿屋、商店、教会、魔術師ギルド、ダンジョン入口のすべてがキャラクター作成画面を表示
2. **施設の識別システムが完全に破綻** - どの施設をクリックしても同じキャラクター作成画面が開く
3. **以前の調査結果との相違** - 初回調査では冒険者ギルドのメニューが表示されていたが、現在はすべてキャラクター作成画面

## 各施設の調査結果詳細

### 冒険者ギルド ✅ **正常動作**
表示されるメニュー：
- >>> キャラクター作成
- パーティ編成
- キャラクター一覧
- クラスチェンジ
- 終了

テスト結果：
* [冒険者ギルド]-[>>> キャラクター作成]: **正常動作** - キャラクター作成画面に遷移
* [冒険者ギルド]-[パーティ編成]: 未実装（メニューが消える）
* [冒険者ギルド]-[キャラクター一覧]: 未実装（メニューが消える）
* [冒険者ギルド]-[クラスチェンジ]: 未実装（メニューが消える）
* [冒険者ギルド]-[終了]: **正常動作** - 施設メニューを閉じる

### 宿屋 ❌ **異常動作**
**問題**: 冒険者ギルドのキャラクター作成画面が表示される
* 宿屋ボタンをクリックしても独自メニューが表示されない
* 代わりにキャラクター作成画面が開く
* 施設の識別ロジックに重大な問題

### 商店 ❌ **異常動作**
**問題**: 冒険者ギルドのキャラクター作成画面が表示される
* 商店ボタンをクリックしても独自メニューが表示されない
* 代わりにキャラクター作成画面が開く
* 施設の識別ロジックに重大な問題

### 教会 ❌ **異常動作**
**問題**: 冒険者ギルドのキャラクター作成画面が表示される
* 教会ボタンをクリックしても独自メニューが表示されない
* 代わりにキャラクター作成画面が開く
* 以前は独自メニューを表示していたが、現在は異常動作

### 魔術師ギルド ❌ **異常動作**
**問題**: 冒険者ギルドのキャラクター作成画面が表示される
* 魔術師ギルドボタンをクリックしても独自メニューが表示されない
* 代わりにキャラクター作成画面が開く
* 施設の識別ロジックに重大な問題

### ダンジョン入口 ❌ **異常動作**
**問題**: 冒険者ギルドのキャラクター作成画面が表示される
* ダンジョン入口ボタンをクリックしても独自メニューが表示されない
* 代わりにキャラクター作成画面が開く
* 施設の識別ロジックに重大な問題

## 推奨される対応

### 1. **最優先：施設識別ロジックの修正**
**重大な問題**: 5つの施設（宿屋、商店、教会、魔術師ギルド、ダンジョン入口）がすべて冒険者ギルドとして動作
- 施設ボタンのクリックハンドラーを確認
- 施設IDまたは施設タイプの判定ロジックを調査
- 各施設が正しく識別されるように修正

### 2. **高優先：各施設のメニュー実装確認**
- 宿屋、商店、教会、魔術師ギルド、ダンジョン入口の独自メニューが実装されているか確認
- 実装されていない場合は各施設のメニューを作成

### 3. **中優先：冒険者ギルドの機能拡充**
- パーティ編成機能の実装
- キャラクター一覧機能の実装  
- クラスチェンジ機能の実装

### 4. **技術的調査ポイント**
1. **施設ボタンのevent handler** - 各ボタンが正しい施設IDを渡しているか
2. **FacilityManagerの処理** - 施設の識別と適切なハンドラーの呼び出し
3. **施設登録システム** - 各施設が正しく登録されているか
4. **ウィンドウ生成ロジック** - 施設ごとに正しいウィンドウが生成されているか

## 技術的根本原因の特定（2025年7月4日詳細調査）

### 調査により判明したシステム構成

1. **正常なコード構成**：
   - OverworldManager (271-282行) → FacilityManager.enter_facility() → 各施設のenter()メソッド
   - 各施設は独自の`_create_facility_menu_config()`を正しく実装
   - 教会: `_create_temple_menu_config()` - 蘇生サービス、治療・祝福サービスなど
   - 宿屋: `_create_inn_menu_config()` - 冒険準備、アイテム倉庫など
   - 冒険者ギルド: `_create_guild_menu_config()` - キャラクター作成、パーティ編成など

2. **想定される問題箇所**：
   - **FacilityMenuWindow** での設定の変換・検証処理
   - **WindowManager** のウィンドウレジストリでの名前衝突
   - **CharacterCreationWizard** が何らかの理由で常にアクティブになっている

### 症状の詳細

- **すべての施設** で同じキャラクター作成画面（「ステップ1/5: キャラクター名を入力してください」）が表示
- 以前の調査では冒険者ギルドのメニューが表示されていたが、現在はそれも破綻
- ウィンドウスタックまたはメッセージルーティングでの深刻な問題

### 推奨される修正アプローチ

1. **WindowManager.create_window()のデバッグ**：
   - 各施設のウィンドウ作成時に正しい設定が渡されているか確認
   - ウィンドウID重複やレジストリ問題をログ出力で検証

2. **FacilityMenuWindow初期化の詳細調査**：
   - `_validate_and_convert_config()`での設定破損確認
   - FacilityTypeとmenu_itemsの変換過程を追跡

3. **CharacterCreationWizard強制表示の調査**：
   - 何らかの理由でCharacterCreationWizardが他の施設でも起動されている可能性

## 問題解決完了（2025年7月4日）

### 根本原因の特定と修正

**真の問題**: 「メニューが消える」や「施設識別システムの問題」ではなく、**デバッグ時のマウスクリック座標が間違っていた**ことが原因でした。

### 解決プロセス

1. **デバッグログの詳細追加**: WindowManager、FacilityMenuWindow、イベント処理にデバッグログを追加
2. **マウスクリック検出の確認**: pygame-guiのイベント処理まで正しく到達していることを確認
3. **正確な座標でのテスト**: 各施設ボタンの正しい座標をクリックすることで問題を解決

### 最終検証結果

#### ✅ 冒険者ギルド（正常動作）
- キャラクター作成
- パーティ編成  
- キャラクター一覧
- クラスチェンジ
- 終了

#### ✅ 教会（正常動作）
- 蘇生サービス
- 治療・祝福サービス
- 神父と話す
- 祈祷書購入
- 終了

#### ✅ 宿屋（正常動作）
- 冒険の準備
- アイテム預かり
- 宿屋の主人と話す
- 旅の情報を聞く
- 酒場の噂話
- パーティ名を変更
- 終了

### 技術的確認事項

1. **施設識別システム**: 完全に正常動作
2. **FacilityManager**: 各施設を正しく区別・処理
3. **WindowManager**: ウィンドウ作成・表示が正常
4. **FacilityMenuWindow**: 各施設固有の設定を正しく反映
5. **UI要素**: pygame-guiによるボタン表示・クリック処理が正常

## 結論

**すべての施設メニューが正常に動作することが確認されました**。当初報告されていた「メニューが消える」や「キャラクター作成画面が表示される」問題は、デバッグ用のマウスクリック座標の誤りが原因でした。システム自体には問題はありません。

