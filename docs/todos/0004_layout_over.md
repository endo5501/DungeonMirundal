# 現象

以下の画面で、背面のタイル/ボタンから文字列が大幅にはみ出ている
* ESC-[パーティ状況]で表示されるパーティ状況の情報
* ESC-[ゲーム保存]で表示されるセーブデータ
* ESC-[ゲームロード]で表示されるセーブデータ
* [魔術師ギルド]-[魔法分析]で表示されるメニュー
* [魔術師ギルド]-[魔法分析]-[パーティの魔法適性分析]で表示されるメッセージタイル
* [魔術師ギルド]-[魔法分析]-[キャラクター分析]-[(キャラクター)]で表示される分析メッセージ。これは情報量が多すぎるので、スクロールできるようにするべき
* [商店]-[アイテム売却]。改行がそのまま表示されてしまっている
* [教会]-[祝福サービス]。また、この画面の[祝福を受ける]ボタンも文字がはみ出ている
* [冒険者ギルド]-[パーティ編成]の各ボタン
* [宿屋]-[アイテム整理]。改行がそのまま表示されてしまっている

## 原因分析 (2025-06-25)

**根本原因**：
- `UIDialog`と`UIButton`クラスでテキストの幅制約が実装されていない
- 長いテキストが自動的に折り返されず、コンテナ領域を超えて描画される
- ダイアログサイズが固定で、テキスト量に応じた動的調整がない

**詳細調査結果**：
1. UIDialogクラス（デフォルトサイズ400x200）では、メッセージ描画時に幅制約なし
2. UIButtonクラスでは、ボタンテキストがボタン幅を無視して描画される
3. 既存の`base_facility.py`では部分的な修正（動的サイズ計算）が実装済み
4. 改行文字（\n）が適切に処理されていない箇所がある

## 修正内容 (2025-06-25)

### ファイル: `/home/satorue/Dungeon/src/ui/base_ui_pygame.py`

**1. テキスト折り返し機能の追加**
```python
def wrap_text(text: str, font: pygame.font.Font, max_width: int) -> List[str]:
    """テキストを指定幅で折り返す"""
    # 単語単位での折り返しと改行文字の処理を実装
```

**2. UIButtonクラスの修正**
- ボタン内でのテキスト幅制限（マージンを考慮）
- 複数行テキストの中央揃え描画
- フォールバック処理の改善

**3. UIDialogクラスの修正**
- 既存の改行を考慮した折り返し処理
- ダイアログ内でのテキスト幅制限（マージン40px）
- 空行の適切な処理

### ファイル: `/home/satorue/Dungeon/src/overworld/overworld_manager_pygame.py`

**パーティ状況ダイアログの動的サイズ調整**
- テキスト量に基づくダイアログ幅の自動調整（500-700px）
- 行数に基づく高さの自動調整（300-600px）
- 画面中央への配置とOKボタンの適切な位置調整

## 修正結果 (2025-06-25)

**テスト結果**：
- ✅ ゲーム起動と基本UI動作の確認
- ✅ パーティ状況ダイアログでのテキスト折り返し機能の動作確認
- ✅ ボタンテキストの複数行表示対応
- ✅ 改行文字の適切な処理

**改善された機能**：
- テキストがUI要素の境界を超えることがなくなった
- 長いテキストが自動的に適切な位置で折り返される
- ダイアログサイズがコンテンツに応じて動的に調整される
- 既存の改行記号が適切に処理される

## ステータス

**大部分解決済み** ✅

基本的なテキスト折り返し機能と動的サイズ調整が実装され、主要なレイアウト問題が解決されました。特定の施設での細かい調整が今後必要な場合があります。
