# 0090: 優先的にリファクタリングすべきコード

## 概要

`src/` ディレクトリ以下のコードレビューを実施した結果、いくつかのファイルで設計上の改善点が見られました。
特に、クラスの責務が過大になっている「God Object」問題や、クラス間の結合度が高い問題が散見されます。
これらの問題を解決することで、コードの保守性、テスト容易性、拡張性が向上します。

---

### 1. `src/core/game_manager.py`

- **問題点:**
  - ゲーム全体のロジック（状態管理、UI、入力、シーン遷移、データ管理）が集中しており、典型的な「God Object」となっている。
  - 各マネージャー（Overworld, Dungeonなど）と密結合しており、変更が他に影響を与えやすい。
  - コールバック関数による連携が多く、処理の流れが追いにくい。

- **リファクタリング方針:**
  - **シーン管理システムの導入:** ゲームの状態（地上、ダンジョン、戦闘など）を個別の「シーン」クラスに分離する。`GameManager`はシーンの切り替えと管理に専念させる。
  - **イベントバスの導入:** コールバックの代わりに、コンポーネント間で疎結合な通信を行うイベントバスを導入する。これにより、依存関係が明確になり、拡張性が向上する。
  - **依存性注入 (DI):** 各マネージャーのインスタンス生成と依存関係の解決をDIコンテナに任せることで、テスト容易性を高める。

---

### 2. `src/character/character.py`

- **問題点:**
  - キャラクターの基本情報、ステータス、インベントリ、装備、魔法、状態異常など、非常に多くの責務を負っている。
  - `initialize_*` メソッド群による遅延初期化が多用されており、オブジェクトの状態が複雑化している。
  - メソッド内で他のマネージャー（`inventory_manager`など）を直接インポートしており、依存関係が隠蔽されている。

- **リファクタリング方針:**
  - **コンポーネントパターンへの移行:** `Character`クラスをコンポーネントのコンテナとし、各機能（`EquipmentComponent`, `InventoryComponent`, `SpellbookComponent`など）を独立したクラスとして実装する。
  - **依存関係の明確化:** グローバルなマネージャーへの直接依存を避け、コンストラクタやメソッド経由で依存性を注入する。

---

### 3. `src/combat/combat_manager.py`

- **問題点:**
  - `execute_action`メソッドが多くの条件分岐を持ち、新しいアクションの追加が困難。
  - 戦闘の各フェーズ（準備、戦闘中、勝利、敗北）のロジックが混在している。

- **リファクタリング方針:**
  - **Strategy パターン:** 戦闘アクション（攻撃、魔法、防御など）を個別の戦略クラスに分離し、`CombatManager`は選択された戦略を実行する役割に徹する。
  - **State パターン:** 戦闘の各フェーズを個別の状態クラスに分離し、状態遷移のロジックをカプセル化する。

---

### 4. `src/debug/dbg_api.py` と `src/debug/dbg_api_improved.py`

- **問題点:**
  - 2つのファイル間で機能とコードの重複が非常に多い。

- **リファクタリング方針:**
  - **コードの統合:** `dbg_api_improved.py` の内容を `dbg_api.py` に統合し、古いファイルを削除する。あるいは、共通するロジックをヘルパーモジュールに抽出し、両ファイルから利用する形に整理する。

---

### 4. `src/rendering/dungeon_renderer_pygame.py`

- **問題点:**
  - 描画ロジックとプレイヤーの入力処理ロジックが混在している。

- **リファクタリング方針:**
  - **入力処理の分離:** プレイヤーの移動や回転などの入力処理を `DungeonInputHandler` のような別のクラスに分離する。`DungeonRendererPygame` は、渡されたゲーム状態を描画することに専念させる。
