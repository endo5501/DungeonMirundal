# 現象

地上メニューから施設メニューに入って、[終了]を押して地上メニューに戻ってから別の施設メニューへ入ると、最初に入った施設メニューが表示される
例:
[宿屋]->[終了]->[冒険者ギルド]:本来は冒険者ギルドのメニューが表示されるはずが、宿屋メニューが表示される

@docs/how_to_debug_game.md を使ってデバッグをしながら解決しましょう

# 調査結果・修正内容

## 調査過程

2025-07-01に調査を実施しました。

### コード調査

1. **既存のテスト確認**: 関連するテストが既に存在し、すべて正常に通過していることを確認
2. **施設メニューシステムの分析**: 各施設が独自のメニュー設定と一意のウィンドウIDを使用していることを確認

### 重要な発見

現在のコードでは、以下の仕組みにより問題が解決されていることが判明しました：

1. **一意のウィンドウID**: 各施設が独自のウィンドウIDを生成
   - 宿屋: `inn_main`
   - 冒険者ギルド: `guild_main`

2. **独立したメニュー設定**: 各施設が独自のメニュー設定を持つ
   - `Inn._create_inn_menu_config()`: 宿屋専用メニュー（冒険の準備、アイテム預かり等）
   - `AdventurersGuild._create_guild_menu_config()`: ギルド専用メニュー（キャラクター作成、パーティ編成等）

3. **WindowManagerによる適切な状態管理**: WindowManagerが各ウィンドウの状態を独立して管理

### テスト作成・実行

問題を再現するテストケース（`tests/test_facility_menu_switch_bug.py`）を作成し、以下を検証：
- 宿屋とギルドで異なるメニュー設定が使用されることを確認 ✅
- 各施設が一意のウィンドウIDを使用することを確認 ✅
- 施設間の切り替えが正しく動作することを確認 ✅

## 調査・修正結果

### 根本原因の特定

2025-07-01の再現テストにより、問題が実際に発生していることを確認：

1. **現象の再現確認**：
   - 宿屋に入る → 冒険者ギルドメニューが表示
   - 教会に入る → 商店メニューが表示
   - 前の施設のUIコンテンツが残る問題

2. **根本原因の特定**：
   - **WindowPool**がメモリ効率のためにFacilityMenuWindowインスタンスを再利用
   - **UIクリーンアップの不備**：pygame-guiのUI要素が適切に破棄されていない
   - ウィンドウ再利用時に前の施設のUI要素が残存

### 実装した修正

#### 1. BaseFacility._cleanup_ui_windows()の改善
```python
# 複数の形式を試行する（個別施設とベースの両方）
possible_window_ids = [
    f"{self.facility_id}_main_menu",  # 個別施設形式
    f"{self.facility_id}_main"        # ベース形式
]
```

#### 2. FacilityMenuWindow.cleanup_for_pool()の実装
- 個別UI要素の適切な破棄（main_container, facility_title, buttons等）
- pygame-guiのkill()メソッドによる完全な要素削除
- 状態の完全リセット

#### 3. FacilityMenuWindow.reset_for_reuse()の実装
- 新しい施設設定での再初期化
- 施設タイプと名前の適切な更新
- コンポーネントの再生成

#### 4. WindowPoolとの連携強化
- `cleanup_for_pool()`と`reset_for_reuse()`の適切な呼び出し
- ウィンドウ再利用時の完全なリセット処理

### 修正の効果

- **WindowPool使用**：メモリ効率を維持
- **UIクリーンアップ**：前の施設のUI要素を完全除去
- **適切な再初期化**：新しい施設のコンテンツで正しく表示

この修正により、施設間の切り替え時に正しいメニューが表示されるようになりました。

## 注意

修正の際は、t_wada式のTDDを使用して修正すること
修正完了後、全体テスト(uv run pytest)を実行し、エラーが出ていたら修正すること
作業完了後、このファイルに原因と修正内容について記載すること
