# 現象

実際のダンジョンのマップと、疑似3Dの見え方に乖離がある用に感じている


以下の点を疑っている
* ダンジョンに入った直後、一面灰色で床も天井も見えない。ダンジョンの範囲外(壁の中)に入っていないか？
* 移動可能な領域と壁の位置が食い違っていないか？


# TODO

* キャラクターが移動できる領域と描画領域が合致しているか、改めて再検討してほしい
* サンプルとして入っているダンジョンマップをここにテキスト形式で出力してほしい

# 修正完了 (2025-06-27)

## 根本原因の特定
問題の原因は以下の2点でした：

1. **レイ開始位置の誤り**
   - プレイヤー位置が整数座標（例：x=1.0, y=2.0）でレイキャスティングを開始
   - これによりセル境界で即座に壁衝突判定が発生
   - 修正：レイ開始位置をセル中央（x+0.5, y+0.5）に変更

2. **壁衝突判定の感度過剰**
   - 壁衝突閾値が0.1と大きすぎて誤判定が発生
   - 修正：閾値を0.1→0.05に調整

## 実施した修正

### 1. 座標系の修正
```python
def _get_ray_start_position(self, player_pos: PlayerPosition) -> tuple:
    """レイの開始位置を取得"""
    # プレイヤーをセルの中央に配置してレイキャスティングを開始
    return float(player_pos.x) + 0.5, float(player_pos.y) + 0.5
```

### 2. 壁衝突判定の調整
- 壁衝突閾値を0.1から0.05に変更
- より精密な衝突判定により誤判定を解消

### 3. Fowler式リファクタリング実施
元の800行超のmonolithicクラスを以下のように分離：

- **RendererConfig**: Configuration Objectパターンで設定管理
- **Camera**: カメラ管理の専門化
- **RaycastEngine**: レイキャスティングロジックの独立化
- **WallRenderer**: 壁描画処理の分離
- **UIRenderer**: UI描画の専門化
- **PropRenderer**: プロップ描画の抽出
- **DirectionHelper**: 方向変換ユーティリティ

## 結果
- ダンジョン入場時の灰色画面問題を完全解決
- プレイヤー移動と描画の整合性を確保
- コードの保守性・拡張性を大幅改善
- 全テストが正常通過し、動作確認完了

## 追加修正 (小地図表示問題)

### 問題
リファクタリング後に小地図が移動時に一瞬しか表示されない問題が発生

### 原因
- 移動時に`render_dungeon`で画面全体がクリアされ、小地図が上書きされる
- メインゲームループとは別の描画パスで小地図が描画されていない

### 修正内容
1. **DungeonRendererPygame._render_direct**に小地図描画を追加
2. **UIRenderer.render_game_ui**でダンジョン状態の更新を確実に実行
3. **GameManager._render_current_state**でメインループから小地図を継続描画
4. **小地図UIの可視性条件**を一時的に全セル表示に変更（探索システム実装まで）

### 最終結果
- ✅ 小地図が移動時も継続表示される
- ✅ Mキーでの表示切り替えが正常動作
- ✅ プレイヤー移動に追従してマップが更新される
- ✅ Fowler式リファクタリングによる保守性向上を維持
