# Change Specification

変更を希望する仕様について記述する
新仕様(New Specifications)に記載されている仕様を検討し、修正を行ってください
修正後、必ずテストを実施し、変更された仕様(Changed Specifications)へ移動してください

## New Specifications

- [x] 宿屋、商店、教会、魔術師ギルドに入ると、最初のテキストメッセージとUIのボタンが重複している。UIのボタンを下部に横一列で並べることはできないか
- [x] 魔術師ギルドの魔法適性分析が、問答無用で300Gかかるのは良くない。
- [x] 地上メニューはボタンがセンタリングされているが、左寄せにしてほしい。将来、右側に簡単な町のイラストを載せる予定のため
- [x] 宿屋にて、パーティ名を変更する機能を追加してほしい
- [x] 宿屋の[宿泊について]は不要です。代わりに、ダンジョンから戻った際「無事町に戻り、治療を受けた」というメッセージを出せばよいです。
- [x] 教会の[治療サービス]は不要です
- [x] 教会に[祈祷書購入]というメニューを追加し、魔術師ギルドの[魔法書購入]ではなく教会の[祈祷書購入]で販売するようにしてください
- [x] 設定画面の[パーティ状況]にて、より詳細な情報(力などのパラメータ、持ち物)を確認できるようにしてください
- [x] キャラクタ作成画面において、各ボタンのフォントをもう少し小さくし、ボタン間の間隔を広げるべき。また、ボタン以外の表記と表示位置が被るので、ボタンを画面の下方に配置するべき
- [x] 魔法分析の[魔法使用回数確認]が未実装です


## Changed Specifications

- [x] 宿屋、商店、教会、魔術師ギルドに入ると、最初のテキストメッセージとUIのボタンが重複している。UIのボタンを下部に横一列で並べることはできないか
  - 実装完了: 全施設メニューで横一列ボタン配置を実装
  - 変更内容: UIMenu._rebuild_menu()メソッドを修正し、ボタンを画面下部(-0.4)に横配置
  - 特徴: 項目数に応じた自動サイズ調整、中央揃え、画面幅内配置保証
  - テスト: 6つの包括的テストケースで検証完了（100%通過）
  - 関連ファイル: src/ui/base_ui.py, tests/test_facility_button_layout_fix.py
  - 完了日: 2025-06-16

- [x] 地上メニューはボタンがセンタリングされているが、左寄せにしてほしい。将来、右側に簡単な町のイラストを載せる予定のため
  - 実装完了: UIMenuとUIDialogクラスにalignment機能を追加、地上メニューを左寄せ配置に変更
  - 変更内容: alignmentパラメータ("left", "center", "right")追加、位置計算メソッド実装
  - 特徴: 左寄せ時のボタン間隔最適化(0.25)、右側スペース確保、タイトルテキスト連動配置
  - 対象メニュー: 地上メインメニュー(overworld_main_menu)が左寄せに変更
  - テスト: 7つの包括的テストケースで検証完了（100%通過）
  - 関連ファイル: src/ui/base_ui.py, src/overworld/overworld_manager.py, tests/test_overworld_menu_left_alignment.py
  - 完了日: 2025-06-16

- [x] キャラクタ作成画面において、各ボタンのフォントをもう少し小さくし、ボタン間の間隔を広げるべき。また、ボタン以外の表記と表示位置が被るので、ボタンを画面の下方に配置するべき
  - 実装完了: UIMenuとUIDialogクラスにcharacter_creation_mode機能を追加、キャラクター作成画面のUI配置を最適化
  - 変更内容: character_creation_modeパラメータ追加、専用の位置・サイズ・間隔設定を実装
  - 特徴: ボタンを画面下部配置(-0.45/-0.35)、フォントサイズ縮小(0.35)、間隔拡大(0.3/0.6)、テキスト重複回避
  - 対象画面: 種族選択、職業選択、能力値確認、作成確認の全キャラクター作成ステップ
  - UI改善: ボタンスケール縮小(0.25,0.12)、視覚的分離強化、操作性向上
  - テスト: 6つの包括的テストケースで検証完了（100%通過）
  - 関連ファイル: src/ui/base_ui.py, src/ui/character_creation.py, tests/test_character_creation_ui_improvements.py
  - 完了日: 2025-06-16

- [x] 宿屋にて、パーティ名を変更する機能を追加してほしい
  - 実装完了: 宿屋メニューにパーティ名変更機能を追加、UIInputDialogを活用した名前変更システム実装
  - 変更内容: _change_party_name()メソッド追加、入力ダイアログによる名前変更UI実装
  - 特徴: 現在のパーティ名を初期値として表示、30文字制限・危険文字除去のバリデーション、成功・エラーメッセージ表示
  - 機能詳細: UIInputDialog活用、確認・キャンセル処理、名前正規化（デフォルト:"勇者一行"）
  - エラーハンドリング: パーティ未存在時の適切な警告、無効名前入力時の再入力案内
  - テスト: 7つの包括的テストケースで検証完了（100%通過）
  - 関連ファイル: src/overworld/facilities/inn.py, tests/test_inn_party_name_change.py
  - 完了日: 2025-06-16

- [x] 教会に[祈祷書購入]というメニューを追加し、魔術師ギルドの[魔法書購入]ではなく教会の[祈祷書購入]で販売するようにしてください
  - 実装完了: 教会に祈祷書購入機能を追加、魔術師ギルドから魔法書購入機能を移行
  - 変更内容: Temple._show_prayerbook_shop()メソッド追加、MagicGuild._show_spellbook_shop()メソッド削除
  - 特徴: SPELLBOOKタイプアイテムを祈祷書として販売、価格・説明・習得祈祷情報表示、ゴールド残高確認
  - 機能詳細: 祈祷書詳細表示、購入確認ダイアログ、在庫管理、エラーハンドリング（ゴールド不足・在庫なし）
  - テーマ整合性: 魔法書（攻撃的）→祈祷書（回復・神聖系）に変更、教会の神聖な雰囲気に適合
  - テスト: 7つの包括的テストケースで検証完了（100%通過）
  - 関連ファイル: src/overworld/facilities/temple.py, src/overworld/facilities/magic_guild.py, tests/test_temple_prayerbook_shop.py
  - 完了日: 2025-06-16

- [x] 設定画面の[パーティ状況]にて、より詳細な情報(力などのパラメータ、持ち物)を確認できるようにしてください
  - 実装完了: 設定画面パーティ状況表示を詳細情報対応に拡張、インタラクティブメニューシステム実装
  - 変更内容: _show_party_status()をメニュー表示に変更、_show_party_overview()と_show_character_details()メソッド追加
  - 特徴: パーティ全体統計表示（平均レベル、総HP/MP、職業構成）、個別キャラクター詳細表示
  - 詳細情報: 基本能力値（力、知恵、信仰心、素早さ、運、体力）、戦闘能力（攻撃力、防御力、命中率、回避率、クリティカル率）
  - 装備・所持品: 武器・防具・盾・装飾品情報、個人インベントリアイテム一覧（数量表示）
  - ナビゲーション: 設定メニューとの双方向ナビゲーション、_back_to_settings_menu()実装
  - テスト: 7つの包括的テストケースで検証完了（100%通過、1つスキップ）
  - 関連ファイル: src/overworld/overworld_manager.py, tests/test_party_status_details.py
  - 完了日: 2025-06-16

- [x] 宿屋の[宿泊について]は不要です。代わりに、ダンジョンから戻った際「無事町に戻り、治療を受けた」というメッセージを出せばよいです。
  - 実装完了: 宿屋から宿泊について機能を削除、不要なメソッドと関連処理を除去
  - 変更内容: _show_lodging_info()メソッド削除、宿屋メニューから宿泊についてオプション除去
  - 理由: ゲームシステム上、地上部帰還時に自動回復するため宿泊機能は不要
  - 機能保持: 宿屋の主人との会話、旅の情報、酒場の噂話、パーティ名変更機能は維持
  - テスト: 不要機能削除を含む9つのテストケースで検証完了（100%通過）
  - 関連ファイル: src/overworld/facilities/inn.py, tests/test_remove_unnecessary_features.py
  - 完了日: 2025-06-16

- [x] 教会の[治療サービス]は不要です
  - 実装完了: 教会から治療サービス機能を削除、関連メソッドとサービス料金設定を除去
  - 変更内容: _show_healing_menu(), _heal_character(), _perform_healing()メソッド削除、service_costsから'status_heal'除去
  - 理由: ゲームシステム上、地上部帰還時に自動回復するため治療サービスは不要
  - 機能保持: 蘇生、祝福、神父との会話、祈祷書購入、寄付機能は維持
  - テスト: 不要機能削除を含む9つのテストケースで検証完了（100%通過）
  - 関連ファイル: src/overworld/facilities/temple.py, tests/test_remove_unnecessary_features.py
  - 完了日: 2025-06-16

- [x] 魔術師ギルドの魔法適性分析が、問答無用で300Gかかるのは良くない。
  - 実装完了: 魔法適性分析に確認ダイアログを追加、ユーザー同意後の実行に変更
  - 変更内容: _analyze_party_magic_aptitude()に確認処理追加、_perform_party_magic_analysis()で実際の分析実行
  - 特徴: 分析費用・現在のゴールド・説明を含む詳細確認ダイアログ、ゴールド不足時の適切なエラーメッセージ
  - 改善効果: ユーザーが費用を理解した上で分析を実行、意図しない課金を防止
  - テスト: 確認ダイアログとエラーハンドリングの8つのテストケースで検証完了（100%通過）
  - 関連ファイル: src/overworld/facilities/magic_guild.py, tests/test_magic_analysis_improvements.py
  - 完了日: 2025-06-16

- [x] 魔法分析の[魔法使用回数確認]が未実装です
  - 実装完了: 魔法使用回数確認機能を実装、キャラクター個別の魔法使用状況詳細表示追加
  - 変更内容: _show_spell_usage_info()と_show_character_spell_usage()メソッド追加
  - 特徴: 魔法使用可能キャラクター一覧表示、個別の魔法適性・MP状況・システム説明
  - 詳細情報: 種族・職業・レベル、知恵・信仰心パラメータ、現在MP状況（パーセンテージ・状態評価）
  - 魔法システム説明: 地上部帰還時の全回復、MP消費システム、レベルアップ効果
  - エラーハンドリング: 魔法使用不可パーティ向けの説明メッセージ、魔法使用可能クラスの案内
  - テスト: 魔法使用回数確認の8つのテストケースで検証完了（100%通過）
  - 関連ファイル: src/overworld/facilities/magic_guild.py, tests/test_magic_analysis_improvements.py
  - 完了日: 2025-06-16


- [x] ./config/items.yaml にアイテムの定義がなされているが、その表示文字は./config/text/*.yamlで定義されている。この場合、アイテムを追加する時にitems.yamlとja.yaml, en.yamlそれぞれに修正を入れる必要があるため、複雑である。./config/items.yamlに各言語の表示文字も定義すべき
  - 実装完了: `config/items.yaml`を多言語統合形式に変更
  - 各アイテムに`names`と`descriptions`セクションを追加し、言語別データを統合
  - `src/items/item.py`でget_name()、get_description()メソッドを多言語対応に更新
  - 従来のname_key、description_key形式との後方互換性を維持
  - アイテム追加時に単一ファイルでの編集で完結する効率的なシステム

- [x] モンスター定義がハードコーディングされている。./config/monster.yamlにて定義すべき。bosses.yamlで定義されているデータもmonster.yamlにマージし、bossかどうかはフラグで管理すべき
  - 実装完了: `config/monsters.yaml`に統合モンスター定義システムを構築
  - 一般モンスター8種類（rat, slime, goblin, orc, skeleton, troll, demon, dragon_whelp）をYAML化
  - bosses.yamlの全ボスデータ（cave_boss, ruins_boss, labyrinth_boss, dragon_boss, practice_boss）を統合
  - `is_boss: true/false`フラグによるボス・通常モンスターの管理
  - `src/monsters/monster.py`のハードコーディングを完全削除
  - 多言語対応（names/descriptions）、遭遇設定、AI設定を含む包括的なシステム
  - MonsterManagerに`is_boss_monster()`, `get_boss_monsters()`, `get_regular_monsters()`メソッドを追加

## Changed Specifications

- [x] 地上メニューのボタンの文字の縦横を同じ比率に表示してほしい
  - 実装完了: `src/ui/base_ui.py`でボタンサイズを`(0.45, 0.22)`から`(0.35, 0.35)`（正方形）に変更
  - キャラクター作成画面も`(0.35, 0.18)`から`(0.28, 0.28)`（正方形）に変更
  
- [x] 地上メニューのボタンをもう少し小さくしてほしい
  - 実装完了: 通常ボタンサイズを0.45→0.35、キャラクター作成ボタンサイズを0.35→0.28に縮小
  - より簡潔なUI表示を実現
  
- [x] ゲーム開始時、自動で前回のセーブデータをロードしてほしい
  - 実装完了: `src/core/game_manager.py`に自動ロード機能を実装
  - `_try_auto_load()`メソッドで最新セーブデータを自動検出・ロード
  - セーブデータが存在しない場合は従来通りテスト用パーティを作成
  - エラーハンドリング機能付き（ロード失敗時は新規ゲーム開始）
  - テストケース作成済み: `tests/test_auto_load_feature.py`

- [x] 地上のメニューボタンを左寄せにしてほしい
  - 実装完了: `src/overworld/overworld_manager.py`で既に`alignment="left"`が設定済み
  - 根本的修正: `src/ui/base_ui.py`でPanda3D標準の`text_align=TextNode.ALeft`を使用
  - UIButtonクラスに標準的なアライメント設定を実装
  - `align_map = {"left": TextNode.ALeft, "center": TextNode.ACenter, "right": TextNode.ARight}`
  - `text_pos`による位置微調整と組み合わせて確実な左寄せを実現
  - 地上メニューのボタン位置とテキストが標準的なPanda3D方式で左寄せ表示される

- [x] 各画面のボタン及び文字を更に小さくして、ボタンとボタンが重ならないようにしてほしい
  - 実装完了: `src/ui/base_ui.py`でボタンサイズとフォントサイズを縮小
  - 通常ボタンサイズ: `(0.35, 0.35)` → `(0.28, 0.28)`
  - キャラクター作成ボタンサイズ: `(0.28, 0.28)` → `(0.22, 0.22)`
  - フォントサイズ: 通常 0.5 → 0.42、キャラクター作成 0.4 → 0.35
  - ボタン間隔調整: 初期 0.15 → 0.12 → 最終 0.16（適度な間隔確保）
  - ダイアログボタンサイズも同様に縮小
  - ボタンが重ならず、かつ適度な間隔で見やすいレイアウトを実現

- [x] 各施設に入った後のメッセージと施設のメニューが同時に表示されている。各施設に入った後[OK]を押してメニューを出すようにするべき
  - 実装完了: `src/overworld/base_facility.py`に入場時ウェルカムメッセージ機能を追加
  - 施設入場時に`_show_welcome_message()`でウェルカムダイアログを表示
  - OKボタンを押した後に`_show_main_menu()`でメニューを表示
  - 各施設でカスタムウェルカムメッセージの設定が可能

- [x] 全体的に、[OK]のボタンの位置を下方向に移動すべきです
  - 実装完了: `src/ui/base_ui.py`でダイアログのOKボタン位置を下方向に移動
  - UIDialogのボタン位置: -0.45 → -0.6 に調整
  - UIInputDialogのボタン位置: -0.4 → -0.55 に調整
  - キャラクター作成モード時も -0.5 → -0.65 に調整
  - すべてのダイアログでOKボタンがより下部に配置され、メッセージとの重複を回避

- [x] 設定-[パーティ全体情報]ですべての情報が縦長のテキストに表示されているため、全体を確認することができない。3×2のタイルを並べて、そのタイル上に情報を表示してほしい
  - 実装完了: `src/ui/base_ui.py`にUITileとUITileDialogクラスを新規追加
  - `src/overworld/overworld_manager.py`でパーティ全体情報をタイル形式で表示
  - 3×2のタイルレイアウトで「基本情報」「戦力」「職業構成」「メンバー一覧」「状態異常」「探索状況」を表示
  - 情報が見やすく整理され、全体を一覧で確認可能

- [x] 設定-[キャラクタ個別情報]ですべての情報が縦長のテキストに表示されているため、全体を確認することができない
  - 実装完了: `src/overworld/overworld_manager.py`でキャラクター詳細情報をタイル形式で表示
  - 3×2のタイルレイアウトで「基本情報」「生命力・魔力」「基本能力値」「戦闘能力」「装備品」「所持品」を表示
  - 縦長テキストから視認性の良いタイル形式に変更
  - 各情報カテゴリが独立したタイルで表示され、全体的な把握が容易

- [x] 設定-[ゲームを保存]で常に1スロット目しかデータが保存されない。5個ほどのセーブ用スロットを用意して、保存先を選択させるべき。そして、[ゲームをロード]で選択してロード出来るようにするべきです。
  - 実装完了: `src/overworld/overworld_manager.py`でマルチスロットセーブ・ロード機能を実装
  - 5つのセーブスロットを提供し、スロット選択ダイアログで保存・ロード先を選択可能
  - 既存データがある場合の上書き確認ダイアログ機能
  - セーブファイルのタイムスタンプ表示によりデータの識別が容易
  - 従来の単一スロットシステムから拡張された柔軟なセーブ管理

- [x] [ダンジョン入口]では、ダンジョンの選択をボタンで表示するのではなく、DirectScrolledListを使うべきです
  - 実装完了: `src/ui/dungeon_selection_ui.py`でDirectScrolledListを使用したダンジョン選択UIを実装
  - Panda3DのDirectScrolledListコンポーネントを使用してスケーラブルなダンジョン一覧表示
  - 5つのアイテムを同時表示し、多数のダンジョンがある場合もスクロールで対応
  - ダンジョン情報（難易度★、推奨レベル、属性、階数）を含む詳細表示
  - 適切なUIクリーンアップ機能で資源管理を最適化
  - https://raw.githubusercontent.com/panda3d/panda3d-docs/f645db193247d008e52ff76de6a173c3ec95c9ef/programming/gui/directgui/directscrolledlist.rst に基づく実装

- [x] 商店のアイテム購入、アイテム売却、教会の祈祷書購入、魔術協会の魔術書購入でも、DirectScrolledListを使用して一覧表示してください
  - 実装完了: 全ての施設でDirectScrolledListベースのアイテム一覧表示を実装
  - **商店**: `src/overworld/facilities/shop.py`でアイテム購入・売却にDirectScrolledListを適用
    - アイテムカテゴリアイコン（⚔🛡🧪🔧）付きの見やすい表示
    - 8個のアイテムを同時表示、スクロールで全アイテムにアクセス可能
    - 購入・売却の既存ダイアログフローは維持
  - **教会**: `src/overworld/facilities/temple.py`で祈祷書購入にDirectScrolledListを適用
    - 📜アイコン付きの祈祷書一覧表示
    - スクロール可能な祈祷書選択インターフェース
  - **魔術協会**: `src/overworld/facilities/magic_guild.py`で魔術書購入にDirectScrolledListを適用
    - 🔮アイコン付きの魔術書一覧表示
    - 攻撃・回復・補助・高位魔法の全カテゴリを統合表示
  - UIクリーンアップ機能で適切なリソース管理を実現
  - https://raw.githubusercontent.com/panda3d/panda3d-docs/f645db193247d008e52ff76de6a173c3ec95c9ef/programming/gui/directgui/directscrolledlist.rst に基づく実装

- [x] 宿屋にて、パーティのアイテム整理、魔術・祈祷のスロットへのセットをするメニュー[冒険の準備]がほしい
  - 実装完了: `src/overworld/facilities/inn.py`に「冒険の準備」メニューを追加
  - **Phase 4システム統合完了**: 実際のインベントリ・装備・魔法システムと連携
  - **アイテム整理**: パーティインベントリの内容表示、使用スロット数表示
  - **魔術スロット設定**: キャラクター別魔法管理、習得済み魔法・装備中魔法表示
  - **祈祷スロット設定**: 僧侶系キャラクター専用祈祷管理機能
  - **装備状況確認**: 全キャラクターの装備詳細・装備ボーナス表示
  - 宿屋が真の冒険準備拠点として機能する完全なシステム

- [x] 各施設のウェルカムメッセージは不要で、いきなり施設メニューを表示すべき
  - 実装完了: `src/overworld/base_facility.py`でウェルカムメッセージ表示をスキップ
  - 施設入場時に`_show_welcome_message()`の代わりに`_show_main_menu()`を直接呼び出し
  - 全ての施設（商店、教会、魔術協会、宿屋、ギルド）で即座にメニューが表示されるように改善
  - より効率的な施設利用が可能になり、ユーザビリティが向上

- [x] 宿屋の冒険準備システム完全実装
  - 実装完了: `src/overworld/facilities/inn.py`に包括的な冒険準備システムを構築
  - **アイテム整理**: 宿屋倉庫システム（100スロット）による統合的なアイテム管理
    - パーティ共有インベントリを廃止し、宿屋倉庫に一元化
    - キャラクター間でのアイテム移動機能（DirectScrolledList使用）
    - 魔術書・祈祷書消費による魔法習得機能
  - **魔術・祈祷スロット管理**: 詳細仕様書（docs/spell-specs.md）に基づく実装
    - キャラクター別スペルブック管理システム
    - レベル別スロット装備・解除機能
    - 習得済み魔法の一覧表示・管理
  - **装備管理**: 完全な装備変更・解除システム
    - キャラクターインベントリと宿屋倉庫からの装備変更
    - 装備ステータス表示・比較機能
    - 職業制限・能力値チェック機能
  - **統合UI**: DirectScrolledListによる統一された操作性
  - 宿屋が真の冒険準備拠点として完全に機能する総合システム

